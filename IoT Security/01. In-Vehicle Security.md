## **What is there in a Car?**

### **Vehicle Components and Network**
- Modern vehicles contain numerous **Electronic Control Units (ECUs)**.
- **ECUs** are embedded systems that control one or more subsystems in a vehicle.
- Examples of ECUs include:
    - Engine Control Module (ECM)
    - Powertrain Control Module (PCM)
    - Transmission Control Module (TCM)
    - Suspension Control Module (SCM)
- ECUs communicate with each other in a complex **in-vehicle network**, sharing various types of information.
![[Pasted image 20251003130944.png]]
---

## **What is CAN Bus?**
### **Controller Area Network (CAN)**
- Developed in 1986 by **Bosch**, CAN is a bus-based communication standard for in-vehicle networks.
- **CAN bus** allows communication between ECUs in a vehicle.
- **Applications**: It is used in automotive systems, including powertrain, suspension, and braking systems.
- **ISO 11898** (2003) standardized the CAN bus.
- **Data rate**: CAN supports asynchronous communication with a data rate up to **1 Mbps** over a distance of **40 meters**.

---

## **Why CAN Bus?**
### **Advantages of CAN Bus**
1. **Robustness**:
    - Ideal for safety applications due to its durability and reliability.
    - Uses mechanisms such as **bit stuffing**, **bit monitoring**, **frame checks**, **acknowledgments (ACK)**, and **CRC checks** for error detection.
2. **Low Cost**:
    - Helps reduce errors, wiring, weight, and costs in automotive systems.
3. **Flexibility**:
    - Message-based protocol, allowing nodes (ECUs) to be added or removed without updating the entire system.
4. **Efficiency**:
    - Prioritizes messages: high-priority messages have quicker access to the bus.

---
## **CAN Bus Wiring**
### **Wiring and Reliability in CAN Bus**
- The **reliability** of CAN bus is achieved by preventing message collisions to avoid data loss.
- **Shared bus** system and **message handling** reduce the number of wires needed.
- Redundancy improves reliability, but it increases communication costs due to the added wires.
- **Point-to-point** communications were used before CAN bus became the standard.

![[Pasted image 20251003131653.png]]

Explanation of the components:
#### CAN-H and CAN-L:
CAN-H (High) and CAN-L (Low) are the two wires that carry the communication signal in the bus. Communication is done through differential signaling, meaning the voltage difference between these two wires represents the transmitted data.

When both wires are at a low level (around 0V), the logical value is "0". When CAN-H is at a higher level than CAN-L (around 3.5V vs 1.5V), the logical value is "1".

This difference between the signals ensures greater immunity to electrical noise, making CAN resistant to interference.

#### Termination Resistor (120Ω):  
The 120Ω resistor is placed at both ends of the CAN network to prevent signal reflections. This is crucial to maintain the integrity of the signal, especially in long networks. The termination resistor ensures the line is well "closed," and the signal is not distorted by reflections.

#### Stub:
A "stub" is a branch of the bus that connects a control unit (ECU) to the main CAN-Bus. 
Stubs should be as short as possible to avoid interference or delays in data transmission. Signals traveling along the bus can suffer reflections if the branch is too long.

#### ECUs (Electronic Control Units):
Each ECU is a device (such as a sensor, actuator, or controller) connected to the bus that sends and receives data. Each ECU can transmit messages on the CAN bus, but only one device can "speak" at a time to avoid collisions. The protocol manages these collisions using a priority arbitration algorithm.

---
## **CAN Bus Architecture**
### **ECU Architecture**
- **Microcontroller**:
    - The central processing unit of the ECU, responsible for interpreting signals and deciding which messages to send.
    - Allows the connection of other devices, such as sensors and actuators.

---
## **CAN Bus Architecture**
### **CAN Controller**
- Stores received serial bits and passes messages to the processor.
- Transmits bits serially on the bus after receiving from the processor.

---

## **CAN Bus Architecture**
### **CAN Transceiver**
- Protects the CAN controller from overvoltage.
- Converts CAN bus levels to levels that the CAN controller can use.
- Converts the data stream from the CAN controller to CAN bus levels.

---
## **CAN Bus Communication**
### **CAN Bus Signals**
- CAN bus uses differential wired-AND signals.
- It uses two signals, **CAN high (CAN-H)** and **CAN low (CAN-L)**.
- States:
    - **Dominant state**: CAN-H > CAN-L (0 bit).
    - **Recessive state**: CAN-H < CAN-L (1 bit).

---
## **CAN Bus Communication**
### **Signal Processing**
- The CAN bus uses **differential wired-AND signals**.
- Truth table for CAN signals (A and B inputs):
    - A: 0, B: 0 → Output: 0
    - A: 0, B: 1 → Output: 0
    - A: 1, B: 0 → Output: 0
    - A: 1, B: 1 → Output: 1

---

## **Physical and Data Link Layer**

### **CAN Bus Layers**
- The CAN bus is described by both a **data link layer** and a **physical layer**.
- **ISO 11898-1** describes the data link layer, while **ISO 11898-2** describes the physical layer.
- **Key specifications from ISO 11898-2**:
    - CAN nodes must be connected via a two-wire bus with baud rates up to **1 Mbit/s** or **5 Mbit/s** (for CAN FD).
    - **Maximum cable lengths**:
        - **500 meters** at **125 kbit/s**.
        - **40 meters** at **1 Mbit/s**.
    - **Bus termination**: Must use a **120 Ohms resistor**.

---

## **CAN Frames**
### **Standard CAN Frame**
- The standard CAN frame is composed of **8 message fields**.
- **CAN 2.0A** and **CAN 2.0B** differ in the length of the **ID field**

---

## **CAN Frame Message Fields**
### **Message Components**
1. **Start of Frame (SoF)**: A dominant **0** bit signals that a node wants to send a message.
2. **ID**: The identifier field. The lower the ID, the higher the priority. It does not identify the sender.
3. **Remote Transmission Request (RTR)**: Indicates whether the node is sending or requesting data.
4. **Control**: Contains the **Identifier Extension Bit (IEB)** and the **Data Length Code (DLC)**, specifying the data byte length (0 to 8 bytes).
5. **Data**: The payload, containing signals that can be extracted and decoded for information.
6. **CRC**: Ensures the integrity of the data.
7. **ACK**: Indicates whether the data was correctly received by the node.
8. **End of Frame (EoF)**: Marks the end of the CAN frame.
    

---

## **Validity of the CAN Frame**
### **Error Handling and Frame Validity**
- CAN frames must meet specific criteria to be valid.
- If an error is detected in a transmission, the node takes corrective actions.
- Each node has its own **error counter** and can enter one of the following states:
    - **Active**: Normal operation.
    - **Passive**: Node cannot initiate transmission but can still receive.
    - **Bus Off**: Node is excluded from the bus due to errors.

---

## **Validity of the CAN Frame**
### **Error Counters and States**
- **Transmit Error Counter (TEC)**: Increases by 8 if an error occurs during transmission.
- **Receive Error Counter (REC)**: Increases by 1 if there is an error in reception.
- **Recovery**: Errors decrease the counters, while successful transmission reduces both TEC and REC by 1.
- **Node States**:
    - **Active state**: Normal operation.
    - **Passive state**: Can only transmit recessive error flags.
    - **Bus Off state**: Node no longer participates in communication.

---

## **Validity of the CAN Frame**
### **Transition to Bus Off State**
- When the **TEC** exceeds **255**, the node enters **Bus Off state**.
- In this state, the node cannot communicate or transmit on the bus.
- To return to **Error Active state**, the node must either be reset or accumulate **128 consecutive recessive bits**.

---

## **Bus Off Mode**
### **Limp Home Mode**
- **Bus Off** is a denial of service attack on the network, making an ECU temporarily non-operational.
- In **limp home mode**, the ECU runs with predefined parameters and limited functionality (e.g., reduced RPM).
- This mode is meant to allow the vehicle to safely reach a service station or safe location.
- **Warning indicators** on the dashboard signal that the ECU is in limp mode.

---

## **Errors in CAN Bus Frames**
### **Types of Errors**
- **Bit Error**: Occurs when an ECU detects a mismatch between its transmitted bits and those on the CAN bus.
- **Stuff Error**: Happens if five consecutive bits of the same polarity are not followed by a complementary bit (bit stuffing rule violation).
- **CRC Error**: Occurs when the computed CRC differs from the received one.

---

## **Errors in CAN Bus Frames**
### **Additional Error Types**
- **Form Error**: A fixed-form bit field (e.g., End of Frame) has a bit error.
- **ACK Error**: If no node acknowledges the receipt of a frame, an ACK error is triggered.

---

## **Error Flags**
### **Error Detection and Notification**
- When a node detects an error, it raises an **error flag** to warn other nodes on the bus.
- There are two types of error flags:
    - **Active Error Flag**: Issued by nodes in **error-active** mode. It consists of **6 dominant bits**.
    - **Passive Error Flag**: Issued by nodes in **error-passive** mode. This flag is not detectable by other nodes unless they are in **error-active** mode.

---

## **Error Flags**
### **Error Flag Handling**
- Nodes in **error-active** mode issue an **active error flag**, which is used to notify other nodes of the error.
- If a node is in **error-passive** mode, it can only transmit a **passive error flag**, which is not detectable by other nodes in the network.

---

## **Bus Arbitration**
### **Arbitration Process**
- **Bus arbitration** is the process by which nodes gain access to the bus resources for transmission.
- The **CAN arbitration protocol** is both **priority-based** and **non-preemptive**.
- **Non-preemptive** means that a message cannot be interrupted by a higher-priority message once transmission has begun.
- The media access protocol alternates between **contention** and **transmission** phases.

---

## **Bus Arbitration**
### **Arbitration Slots**
- Time is divided into **slots**, each long enough for a message to be transmitted across the bus.
- When the bus is idle, nodes wishing to transmit check if the channel is free.
- If the channel is idle, they wait for the next slot and begin the **contention phase** by transmitting a **Start of Frame (SoF)** bit.

---

## **Bus Arbitration**
### **Node Contention and Winning**
- If multiple nodes want to transmit, each node sends its **ID**.
- The **CAN controller** compares its output with the bus level at the end of each bit cycle.
- The node with the lower **ID** wins the arbitration and gains access to the bus for transmission.

---

## **Bus Arbitration**
### **Arbitration Process**
- If a node loses contention (i.e., it sends a **recessive level** while the bus detects a **dominant level**), it loses access to the bus.
- This is because **dominant bits** override **recessive bits** during arbitration.    

---

## **Bus Arbitration Example**
### **Arbitration Example**
- The arbitration process occurs bit by bit:
    - **S1**: 1 0 0 0 1 0 0 0
    - **S2**: 0 0 1 1 1 0 0 1
    - **S3**: 0 0 1 1 1 0 1 0
    - **Bus**: 0 0 1 1 1 0 0 1
- In this example, **S2 wins** the arbitration at the **7th bit**.

---

## **Bus Arbitration**
### **Transmission After Arbitration**
- Once the winning node finishes its transmission, it ends with an **End of Frame (EoF)**.
- After that, a **3-bit inter-frame symbol** separates the next transmission.
- The bus becomes idle, and arbitration can begin again for subsequent messages.

---

## **Accessing CAN Bus**
### **Accessing the CAN Bus**
- To access the CAN bus, you need to connect to the **On-Board Diagnostic (OBD)** port, which is standard in most modern vehicles.
- **OBD-II** is the most common standard used.
- The OBD-II port is typically located near the driver’s or passenger’s seat.
- A **converter** is required to connect the OBD port to a **USB port** for data extraction.

---

## **Accessing CAN Bus**
### **Making Sense of CAN Data**
- The data captured from the CAN bus can be organized in a table with the following format:
    - **Interface** | **ID** | **Length** | **Data**
- You can convert the **data** part of the frame into **base 10** values to interpret the message.
- However, understanding which **ID** corresponds to which ECU is crucial for correct interpretation.

---

## **CAN Bus Proprietary Encoding**
### **Manufacturer-Specific Encoding**
- Manufacturers often use proprietary or semi-proprietary **CAN encoding** systems.
- **Reasons for proprietary encoding**:
    - **Product differentiation**: Features may be exposed or hidden based on the manufacturer’s choice.
    - **Intellectual Property/Secrecy**: Only the manufacturer understands how to interpret the messages.
    - **Security**: Encryption or obfuscation can be implemented to make reverse engineering harder.
    - **Control over updates**: Manufacturers maintain control over software or hardware updates.        

---

## **Reverse Engineer CAN Traffic - First Approach**
### **Traffic Analysis**
- **Step 1**: Capture a packet trace with multiple packets.
- **Step 2**: Identify actions of interest, such as a door opening.
- **Step 3**: Replay this trace and observe which packet triggers the action.
- This approach helps map **CAN IDs** to specific vehicle actions.    

---
## **Reverse Engineer CAN Traffic - Second Approach**
### **Tools for Reverse Engineering**
- Use tools like **Cansniff** to analyze variations in CAN messages.
- By observing variations in **data field values**, you can infer which actions correspond to specific CAN messages.
- **Hint**: Group packets by **ID** and look for **data variations** when performing actions on the vehicle.    

---
## **Attacker Model**
### **Types of Attacks**
- **Physical or Remote Attack**: An attacker can compromise one or more ECUs either physically or remotely.
- **Attack Objectives**:
    - Inject messages with a **spoofed ID**.
    - **Stop or suspend** message transmission from a compromised ECU.
- **ECU Compromise** Levels:
    - **Weakly compromised**: The attacker cannot inject fabricated messages.
    - **Fully compromised**: The attacker can inject fabricated messages and control the ECU.        

---

## **Fabrication Attack**
### **Injecting Messages**
- A **fabrication attack** requires a fully compromised ECU to inject **messages** with a **forged ID**, **DLC**, and **data**.
- The goal is to override periodic messages sent by legitimate safety-critical ECUs, distracting or disabling them.

---
## **Suspension Attack**
### **Stopping ECU Message Transmission**
- A **suspension attack** requires at least one **weakly compromised ECU**.
- **Objective**: The attacker aims to stop or suspend the transmission of messages from the compromised ECU.
- This attack can affect other ECUs that rely on receiving messages from the compromised ECU.

---

## **Masquerade Attack**
### **Manipulating an ECU While Concealing the Compromise**
- The attacker compromises two ECUs: one as **strong** and the other as **weak**.
- **Objective**: Manipulate a weak ECU while hiding the fact that it's compromised.
- **Process**:
    - The attacker monitors the weak ECU’s traffic.
    - After determining the transmission period, they stop the weak ECU and use the strong one instead.
        

---

## **The Bus-Off Attack**
### **Denial of Service Attack**
- A **bus-off attack** is a **denial of service** (DoS) attack that exploits how ECUs access the bus.
- The attacker doesn’t need to reverse engineer messages or checksums to execute the attack.
- The goal is to **compromise** the network and force ECUs into a **bus-off state**.
- This attack differs from flooding because it does not require a high number of messages.

---

## **The Bus-Off Attack: Adversary Model**

### **Compromising an ECU**
- An attacker can physically or remotely compromise an ECU.
- **No need to reverse engineer** messages or checksums for this attack.
- Once an ECU is compromised, the attacker can inject malicious messages with any **ID**, **DLC**, and **data** onto the CAN bus.
---
## **The Attack: Hint**
### **Exploiting Error Handling**
- The **error handling mechanism** in the CAN bus makes it vulnerable to **bus-off attacks**.
- The attacker can manipulate the **TEC** (Transmit Error Counter) of a healthy ECU by injecting attack messages, causing the victim ECU to reach an error state.
    

---

from slide 54
### The Attack
- Suppose that a victim ( V ) periodically sends a message ( M )
- The attacker can deliver a successful bus-off attack if all conditions are fulfilled:
    - **C1**: Using the same ID
    - **C2**: Transmitting at the same time as ( M )
    - **C3**: Having at least a bit that is dominant in the attack message while being recessive in ( M ) (all preceding bits are equal)

---
### The Attack
- **Figure** from the original paper: “Error handling of in-vehicle networks makes them vulnerable”
- **Dominant** bit condition explained.
![[Pasted image 20251008144344.png]]

---
### Attack Phases
- **Phase 1**: Victim in Error-Active
    - Both adversary and victim start in error-active mode, and the attacker targets one of the victim’s periodic messages
    - The attacker sends the malicious message and the victim’s TEC increases
    - The attacker’s TEC also increases, due to the stuff or bit errors triggered at the adversary node
    - Both nodes automatically retransmit the failed message

---
## Phase 1 to 2:

- After 16 retransmissions, both victim’s and attacker’s TEC = 128 → error-passive
 - As a consequence, the victim attempts the delivery of a passive error flag with 6 recessive bits
- The attempt to transmit this flag persists until the end of the attacker’s frame, after which it is successful (TEC = TEC -1)
- Due to the successful transmission, the adversary does not go to error-passive
![[Pasted image 20251008144634.png]]

## Phase 2: Victim error passive
- Once the scheduled interval of the target message is elapsed, $V$ retransmits $M$ again
- At the same time, the adversary reinjects malicious MMM
- Since the victim is in error-passive, the attacker’s TEC decreases by 1, whereas the victim’s increases by 7 (+8 -1) thus maintaining the error-passive
- Notice that error-passive nodes have longer IFS than error-active, thus difficult for the attacker to synchronize
- The attacker iterates until the victim’s TEC > 255, i.e., bus-off
![[Pasted image 20251008144838.png]]

### TECs Behavior
![[Pasted image 20251008144914.png]]

---
### Important Note
- Remember that CAN ID does not contain actual information on the transmitter.
- The ID contains information that defines the time interval and priority (i.e., safety-critical) of messages.
- The attacker should hence target low-value IDs (dominant) to disconnect possibly safety-critical ECUs.
- Examples: acceleration, braking.

---

### Where to Modify Frames
- In order to satisfy **C3**, the attacker needs to have a dominant bit where the victim has a recessive one. All preceding bits are equal.
- Since IDs should be the same (**C1**), the dominant bit should be either in control or data fields.
- **CRC** and **ACK** are set by the CAN controller and cannot be altered by the attacker.
- As CAN messages usually have at least one and non-zero data values, modify either **DLC** or data values to all 0s.
- Given that DLC is constant over that for each CAN ID, the attacker can learn the value and modify the DLC accordingly.

---

### Difficulties in Setting the ID
- Each ECU cannot acquire the IDs of all received messages, only those that pass through its message filter.
- We can distinguish hence between received message and accepted message.
- The attacker can only read the ID from accepted messages, thus meeting the requirements on the same ID depends on the filter of the victim ECU.
- If there is no filter, then done.

---

### Tx Synchronization
- Knowing everything about ID and how to modify the message, the attacker needs to know when to send it.
- Precise synchronization is essential iteratively for the success of the attack.
- If there is as little as one bit de-synch, there would be no two arbitration winners → attack fails.
- The attacker may leverage the periodicity of CAN frames and send a message every TTT (estimated by observing the traffic) seconds.

---

### Preceded ID
- Although CAN messages are periodic, jitter may impair the effectiveness of the attack.
- To overcome this issue, the attacker can exploit the fact that nodes which have either lost arbitration or had new messages buffered while the bus was busy attempt to transmit their messages as soon as the bus becomes idle.
- Given a node with ID $M$, we define its **preceded ID** as the ID of the message that completed its transmission right before the start of $M$.
![[Pasted image 20251008151940.png]]

---

### Fabrication of Preceded ID
- The injection timing, quantity, and content of fabricated preceded ID messages is fundamental for success.
- Regarding timing, it is crucial to inject the message right before the target one and still deal with the problem of jitter over periodicity.
- The only source of randomness is jitter, which follows a Gaussian distribution with zero mean and sigma standard deviation.

---

### Fabrication of Preceded ID
- The successive times at which the attacker receives the victim's message can be expressed as:
    - **Expected transmit time**
    - **Expected transmit time** of the second message
    - **Delay victim transmit time**
![[Pasted image 20251008152437.png]]

---

### Fabrication of Preceded ID

- We can then compute the next victim’s transmit time as:
$$
t_{n+1}^{vic} = t_{n}^{adv} + T - D + J_{n+1} - J_n = t_{n}^{adv} + T - D + J^* ;
$$
- For fabrication of the preceded ID, the attacker has to start the transmission of its preceded ID message(s) before the target and make the bus busy until it becomes sure that the attack and target messages would synchronize.
- Only this is a random variable.

We can hence write the following constraints for the attacker
1) $t_{fab} < \min(t^{vic}_{n+1}) = t^{adv}_{n} + T - D + \min(J^*)$
2) $t_{fab} + H > \max(t^{vic}_{n+1}) = t^{adv}_{n} + T - D + \max(J^*)$
3) $H = kF \max(J^*) - \min(J^*)$

Jitter: il fenomeno della irregolarità del clock in un segnale digitale (the phenomenon of clock irregularity in a digital signal)

---

### Fabrication of Preceded ID
- $( J^* )$ is a bounded random variable, with boundaries approximated as:
$$
| \max(J^*) | = | \min(J^*) | \simeq I \sqrt{2 \sigma_v}
$$

    - Setting ( I = 3 ) provides a 99.73% confidence interval, and ( I = 4 ) provides a 99.99% confidence interval.
    - To fully exploit the fabricated preceded IDs, the adversary needs to start injecting them prior to the measurable attack parameter.        

---

### Number of Messages
- To satisfy the third constraint, the adversary needs to occupy the bus for a duration of:
    - This can be done by sending 1 or more preceded ID messages.
    - An adversary aiming at minimizing the number of injections should maximize $F$.
    - To this aim, the adversary can exploit the bit-stuffing rule and send messages with the most stuffed bits.
    - With $L = DLC = 8$ , exterior to data:
$$
F^* = \left( 8L + 44 + \left[ \frac{8L}{4} \right] \right) / S_{bus} = \frac{124}{S_{bus}}
$$

---

### Number of Messages
- Based on this, the number of preceded ID messages needed can be expressed as:
$$
\kappa = \left| \frac{\max(J^*) - \min(J^*)}{F^*} \right| = \left| \frac{2\sqrt{2} \sigma_\nu S_{bus}}{124} \right|
$$
    - For $\sigma = 0.025 , \text{ms}$ ,  $S_{\text{bus}} = 500 , \text{Kbps}$, an adversary only needs 1 message with I = 3  and hence $99.73$% confidence.
    - To raise confidence to $99.99$% (i.e., $I = 4$ ), the adversary needs two messages.

---

### Content of Preceding ID Messages
- The adversary needs to decide which ID to use for fabricating the preceded ID messages.
- If only one preceded ID is needed, the attacker can use the next seemingly free ID.
- To be as elusive as possible, such ID can be changed at every attack attempt, choosing among the least frequently sent on the bus.
- If two preceded IDs are needed, the adversary can choose one from the pool as before, but carefully select the second one to have higher priority than the target one.

---

### Preventing Bus-Off Attacks
- The defense mechanism can leverage two features of the bus-off:
    - **F1 (in phase 1)**: At least two consecutive errors occur during the transmission of frames. Thus, we watch for consecutive error frames with an active error flag.
    - **F2 (in phase 2)**: At the time when the error-passive victim’s TEC increases, a message with the same ID will be successfully transmitted by some ECU on the bus.

---

### WeepingCAN
- The bus-off attack is easily detectable by a good intrusion detection system.
- Other approaches include physical layer intrusion detection systems due to differences in hardware between attacker and victim.
- Secure hardware may prevent the attack by detecting and blocking the local transmission of the attacker.
- CAN bus authentication may also prevent these kinds of attacks, but it is unlikely to be implemented.

- **WeepingCAN** is a variation of the original bus-off attack, stealthier than the original one.
- **Differences**:
    - The attacker disables the retransmission of the attack message with the same ID as the victim.
    - The attacker causes recessive bit errors.
    - The attacker does not fabricate preceded ID messages.
    - The attacker randomizes bit errors.

- The attack message has the victim’s ID, bit-time, and prefix bits until a random position where the victim is dominant but the attacker is recessive.
- As for the original bus-off, both attacker and victim have TEC = 0 at the beginning.
- The goal of **WeepingCAN** is to avoid exhibiting temporal differences due to the error state transition → being stealthy.

---

### Attack Cycle
- The attacker synchronizes with the victim using the same approach as the original bus-off.
- The attacker, however, disables the retransmission of the attack packet.
- The attacker injects the attack message.
- The attacker’s CAN controller sends an error-active flag due to the bit error in the attacker’s packet, which increases both attacker’s and victim’s TEC by 8.
- The victim retransmits the original packet and TEC = TEC - 1.
- Victim and attacker decrease their TEC for other transmissions.