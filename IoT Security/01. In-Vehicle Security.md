## **What is there in a Car?**

### **Vehicle Components and Network**

- Modern vehicles contain numerous **Electronic Control Units (ECUs)**.
    
- **ECUs** are embedded systems that control one or more subsystems in a vehicle.
    
- Examples of ECUs include:
    
    - Engine Control Module (ECM)
        
    - Powertrain Control Module (PCM)
        
    - Transmission Control Module (TCM)
        
    - Suspension Control Module (SCM)
        
- ECUs communicate with each other in a complex **in-vehicle network**, sharing various types of information.
![[Pasted image 20251003130944.png]]
---

## **What is CAN Bus?**

### **Controller Area Network (CAN)**

- Developed in 1986 by **Bosch**, CAN is a bus-based communication standard for in-vehicle networks.
    
- **CAN bus** allows communication between ECUs in a vehicle.
    
- **Applications**: It is used in automotive systems, including powertrain, suspension, and braking systems.
    
- **ISO 11898** (2003) standardized the CAN bus.
    
- **Data rate**: CAN supports asynchronous communication with a data rate up to **1 Mbps** over a distance of **40 meters**.

---

## **Why CAN Bus?**

### **Advantages of CAN Bus**

1. **Robustness**:
    
    - Ideal for safety applications due to its durability and reliability.
        
    - Uses mechanisms such as **bit stuffing**, **bit monitoring**, **frame checks**, **acknowledgments (ACK)**, and **CRC checks** for error detection.
        
2. **Low Cost**:
    
    - Helps reduce errors, wiring, weight, and costs in automotive systems.
        
3. **Flexibility**:
    
    - Message-based protocol, allowing nodes (ECUs) to be added or removed without updating the entire system.
        
4. **Efficiency**:
    
    - Prioritizes messages: high-priority messages have quicker access to the bus.

---
## **CAN Bus Wiring**

### **Wiring and Reliability in CAN Bus**

- The **reliability** of CAN bus is achieved by preventing message collisions to avoid data loss.
    
- **Shared bus** system and **message handling** reduce the number of wires needed.
    
- Redundancy improves reliability, but it increases communication costs due to the added wires.
    
- **Point-to-point** communications were used before CAN bus became the standard.

![[Pasted image 20251003131653.png]]

Explanation of the components:
#### CAN-H and CAN-L:
CAN-H (High) and CAN-L (Low) are the two wires that carry the communication signal in the bus. Communication is done through differential signaling, meaning the voltage difference between these two wires represents the transmitted data.

When both wires are at a low level (around 0V), the logical value is "0". When CAN-H is at a higher level than CAN-L (around 3.5V vs 1.5V), the logical value is "1".

This difference between the signals ensures greater immunity to electrical noise, making CAN resistant to interference.

#### Termination Resistor (120Ω):  
The 120Ω resistor is placed at both ends of the CAN network to prevent signal reflections. This is crucial to maintain the integrity of the signal, especially in long networks. The termination resistor ensures the line is well "closed," and the signal is not distorted by reflections.

#### Stub:
A "stub" is a branch of the bus that connects a control unit (ECU) to the main CAN-Bus. Stubs should be as short as possible to avoid interference or delays in data transmission. Signals traveling along the bus can suffer reflections if the branch is too long.

#### ECUs (Electronic Control Units):
Each ECU is a device (such as a sensor, actuator, or controller) connected to the bus that sends and receives data. Each ECU can transmit messages on the CAN bus, but only one device can "speak" at a time to avoid collisions. The protocol manages these collisions using a priority arbitration algorithm.

---
## **CAN Bus Architecture**

### **ECU Architecture**

- **Microcontroller**:
    
    - The central processing unit of the ECU, responsible for interpreting signals and deciding which messages to send.
        
    - Allows the connection of other devices, such as sensors and actuators.
        

---

## **CAN Bus Architecture**

### **CAN Controller**

- Stores received serial bits and passes messages to the processor.
    
- Transmits bits serially on the bus after receiving from the processor.
    

---

## **CAN Bus Architecture**

### **CAN Transceiver**

- Protects the CAN controller from overvoltage.
    
- Converts CAN bus levels to levels that the CAN controller can use.
    
- Converts the data stream from the CAN controller to CAN bus levels.
    

---

## **CAN Bus Communication**

### **CAN Bus Signals**

- CAN bus uses differential wired-AND signals.
    
- It uses two signals, **CAN high (CAN-H)** and **CAN low (CAN-L)**.
    
- States:
    
    - **Dominant state**: CAN-H > CAN-L (0 bit).
        
    - **Recessive state**: CAN-H < CAN-L (1 bit).
        

---

## **CAN Bus Communication**

### **Signal Processing**

- The CAN bus uses **differential wired-AND signals**.
    
- Truth table for CAN signals (A and B inputs):
    
    - A: 0, B: 0 → Output: 0
        
    - A: 0, B: 1 → Output: 0
        
    - A: 1, B: 0 → Output: 0
        
    - A: 1, B: 1 → Output: 1

---

## **Physical and Data Link Layer**

### **CAN Bus Layers**

- The CAN bus is described by both a **data link layer** and a **physical layer**.
    
- **ISO 11898-1** describes the data link layer, while **ISO 11898-2** describes the physical layer.
    
- **Key specifications from ISO 11898-2**:
    
    - CAN nodes must be connected via a two-wire bus with baud rates up to **1 Mbit/s** or **5 Mbit/s** (for CAN FD).
        
    - **Maximum cable lengths**:
        
        - **500 meters** at **125 kbit/s**.
            
        - **40 meters** at **1 Mbit/s**.
            
    - **Bus termination**: Must use a **120 Ohms resistor**.
        

---

## **CAN Frames**

### **Standard CAN Frame**

- The standard CAN frame is composed of **8 message fields**.
    
- **CAN 2.0A** and **CAN 2.0B** differ in the length of the **ID field**.
    

---

## **CAN Frame Message Fields**

### **Message Components**

1. **Start of Frame (SoF)**: A dominant **0** bit signals that a node wants to send a message.
    
2. **ID**: The identifier field. The lower the ID, the higher the priority. It does not identify the sender.
    
3. **Remote Transmission Request (RTR)**: Indicates whether the node is sending or requesting data.
    
4. **Control**: Contains the **Identifier Extension Bit (IEB)** and the **Data Length Code (DLC)**, specifying the data byte length (0 to 8 bytes).
    

---

## **CAN Frame Message Fields**

### **Other Message Components**

5. **Data**: The payload, containing signals that can be extracted and decoded for information.
    
6. **CRC**: Ensures the integrity of the data.
    
7. **ACK**: Indicates whether the data was correctly received by the node.
    
8. **End of Frame (EoF)**: Marks the end of the CAN frame.
    

---

## **Validity of the CAN Frame**

### **Error Handling and Frame Validity**

- CAN frames must meet specific criteria to be valid.
    
- If an error is detected in a transmission, the node takes corrective actions.
    
- Each node has its own **error counter** and can enter one of the following states:
    
    - **Active**: Normal operation.
        
    - **Passive**: Node cannot initiate transmission but can still receive.
        
    - **Bus Off**: Node is excluded from the bus due to errors.

---

## **Validity of the CAN Frame**

### **Error Counters and States**

- **Transmit Error Counter (TEC)**: Increases by 8 if an error occurs during transmission.
    
- **Receive Error Counter (REC)**: Increases by 1 if there is an error in reception.
    
- **Recovery**: Errors decrease the counters, while successful transmission reduces both TEC and REC by 1.
    
- **Node States**:
    
    - **Active state**: Normal operation.
        
    - **Passive state**: Can only transmit recessive error flags.
        
    - **Bus Off state**: Node no longer participates in communication.
        

---

## **Validity of the CAN Frame**

### **Transition to Bus Off State**

- When the **TEC** exceeds **255**, the node enters **Bus Off state**.
    
- In this state, the node cannot communicate or transmit on the bus.
    
- To return to **Error Active state**, the node must either be reset or accumulate **128 consecutive recessive bits**.
    

---

## **Bus Off Mode**

### **Limp Home Mode**

- **Bus Off** is a denial of service attack on the network, making an ECU temporarily non-operational.
    
- In **limp home mode**, the ECU runs with predefined parameters and limited functionality (e.g., reduced RPM).
    
- This mode is meant to allow the vehicle to safely reach a service station or safe location.
    
- **Warning indicators** on the dashboard signal that the ECU is in limp mode.
    

---

## **Errors in CAN Bus Frames**

### **Types of Errors**

- **Bit Error**: Occurs when an ECU detects a mismatch between its transmitted bits and those on the CAN bus.
    
- **Stuff Error**: Happens if five consecutive bits of the same polarity are not followed by a complementary bit (bit stuffing rule violation).
    
- **CRC Error**: Occurs when the computed CRC differs from the received one.
    

---

## **Errors in CAN Bus Frames**

### **Additional Error Types**

- **Form Error**: A fixed-form bit field (e.g., End of Frame) has a bit error.
    
- **ACK Error**: If no node acknowledges the receipt of a frame, an ACK error is triggered.

---

## **Error Flags**

### **Error Detection and Notification**

- When a node detects an error, it raises an **error flag** to warn other nodes on the bus.
    
- There are two types of error flags:
    
    - **Active Error Flag**: Issued by nodes in **error-active** mode. It consists of **6 dominant bits**.
        
    - **Passive Error Flag**: Issued by nodes in **error-passive** mode. This flag is not detectable by other nodes unless they are in **error-active** mode.
        

---

## **Error Flags**

### **Error Flag Handling**

- Nodes in **error-active** mode issue an **active error flag**, which is used to notify other nodes of the error.
    
- If a node is in **error-passive** mode, it can only transmit a **passive error flag**, which is not detectable by other nodes in the network.
    

---

## **Bus Arbitration**

### **Arbitration Process**

- **Bus arbitration** is the process by which nodes gain access to the bus resources for transmission.
    
- The **CAN arbitration protocol** is both **priority-based** and **non-preemptive**.
    
- **Non-preemptive** means that a message cannot be interrupted by a higher-priority message once transmission has begun.
    
- The media access protocol alternates between **contention** and **transmission** phases.
    

---

## **Bus Arbitration**

### **Arbitration Slots**

- Time is divided into **slots**, each long enough for a message to be transmitted across the bus.
    
- When the bus is idle, nodes wishing to transmit check if the channel is free.
    
- If the channel is idle, they wait for the next slot and begin the **contention phase** by transmitting a **Start of Frame (SoF)** bit.
    

---

## **Bus Arbitration**

### **Node Contention and Winning**

- If multiple nodes want to transmit, each node sends its **ID**.
    
- The **CAN controller** compares its output with the bus level at the end of each bit cycle.
    
- The node with the lower **ID** wins the arbitration and gains access to the bus for transmission.

---

## **Bus Arbitration**

### **Arbitration Process**

- If a node loses contention (i.e., it sends a **recessive level** while the bus detects a **dominant level**), it loses access to the bus.
    
- This is because **dominant bits** override **recessive bits** during arbitration.
    

---

## **Bus Arbitration Example**

### **Arbitration Example**

- The arbitration process occurs bit by bit:
    
    - **S1**: 1 0 0 0 1 0 0 0
        
    - **S2**: 0 0 1 1 1 0 0 1
        
    - **S3**: 0 0 1 1 1 0 1 0
        
    - **Bus**: 0 0 1 1 1 0 0 1
        
- In this example, **S2 wins** the arbitration at the **7th bit**.
    

---

## **Bus Arbitration**

### **Transmission After Arbitration**

- Once the winning node finishes its transmission, it ends with an **End of Frame (EoF)**.
    
- After that, a **3-bit inter-frame symbol** separates the next transmission.
    
- The bus becomes idle, and arbitration can begin again for subsequent messages.
    

---

## **Accessing CAN Bus**

### **Accessing the CAN Bus**

- To access the CAN bus, you need to connect to the **On-Board Diagnostic (OBD)** port, which is standard in most modern vehicles.
    
- **OBD-II** is the most common standard used.
    
- The OBD-II port is typically located near the driver’s or passenger’s seat.
    
- A **converter** is required to connect the OBD port to a **USB port** for data extraction.
    

---

## **Accessing CAN Bus**

### **Making Sense of CAN Data**

- The data captured from the CAN bus can be organized in a table with the following format:
    
    - **Interface** | **ID** | **Length** | **Data**
        
- You can convert the **data** part of the frame into **base 10** values to interpret the message.
    
- However, understanding which **ID** corresponds to which ECU is crucial for correct interpretation.
    

Ecco il contenuto delle successive 5 slide:

---

## **CAN Bus Proprietary Encoding**

### **Manufacturer-Specific Encoding**

- Manufacturers often use proprietary or semi-proprietary **CAN encoding** systems.
    
- **Reasons for proprietary encoding**:
    
    - **Product differentiation**: Features may be exposed or hidden based on the manufacturer’s choice.
        
    - **Intellectual Property/Secrecy**: Only the manufacturer understands how to interpret the messages.
        
    - **Security**: Encryption or obfuscation can be implemented to make reverse engineering harder.
        
    - **Control over updates**: Manufacturers maintain control over software or hardware updates.
        

---

## **Reverse Engineer CAN Traffic - First Approach**

### **Traffic Analysis**

- **Step 1**: Capture a packet trace with multiple packets.
    
- **Step 2**: Identify actions of interest, such as a door opening.
    
- **Step 3**: Replay this trace and observe which packet triggers the action.
    
- This approach helps map **CAN IDs** to specific vehicle actions.
    

---

## **Reverse Engineer CAN Traffic - Second Approach**

### **Tools for Reverse Engineering**

- Use tools like **Cansniff** to analyze variations in CAN messages.
    
- By observing variations in **data field values**, you can infer which actions correspond to specific CAN messages.
    
- **Hint**: Group packets by **ID** and look for **data variations** when performing actions on the vehicle.
    

---

## **Attacker Model**

### **Types of Attacks**

- **Physical or Remote Attack**: An attacker can compromise one or more ECUs either physically or remotely.
    
- **Attack Objectives**:
    
    - Inject messages with a **spoofed ID**.
        
    - **Stop or suspend** message transmission from a compromised ECU.
        
- **ECU Compromise** Levels:
    
    - **Weakly compromised**: The attacker cannot inject fabricated messages.
        
    - **Fully compromised**: The attacker can inject fabricated messages and control the ECU.
        

---

## **Fabrication Attack**

### **Injecting Messages**

- A **fabrication attack** requires a fully compromised ECU to inject **messages** with a **forged ID**, **DLC**, and **data**.
    
- The goal is to override periodic messages sent by legitimate safety-critical ECUs, distracting or disabling them.
    

Ecco il contenuto delle successive 5 slide fino alla slide 54:

---

## **Suspension Attack**

### **Stopping ECU Message Transmission**

- A **suspension attack** requires at least one **weakly compromised ECU**.
    
- **Objective**: The attacker aims to stop or suspend the transmission of messages from the compromised ECU.
    
- This attack can affect other ECUs that rely on receiving messages from the compromised ECU.
    

---

## **Masquerade Attack**

### **Manipulating an ECU While Concealing the Compromise**

- The attacker compromises two ECUs: one as **strong** and the other as **weak**.
    
- **Objective**: Manipulate a weak ECU while hiding the fact that it's compromised.
    
- **Process**:
    
    - The attacker monitors the weak ECU’s traffic.
        
    - After determining the transmission period, they stop the weak ECU and use the strong one instead.
        

---

## **The Bus-Off Attack**

### **Denial of Service Attack**

- A **bus-off attack** is a **denial of service** (DoS) attack that exploits how ECUs access the bus.
    
- The attacker doesn’t need to reverse engineer messages or checksums to execute the attack.
    
- The goal is to **compromise** the network and force ECUs into a **bus-off state**.
    
- This attack differs from flooding because it does not require a high number of messages.
    

---

## **The Bus-Off Attack: Adversary Model**

### **Compromising an ECU**

- An attacker can physically or remotely compromise an ECU.
    
- **No need to reverse engineer** messages or checksums for this attack.
    
- Once an ECU is compromised, the attacker can inject malicious messages with any **ID**, **DLC**, and **data** onto the CAN bus.
    

---

## **The Attack: Hint**

### **Exploiting Error Handling**

- The **error handling mechanism** in the CAN bus makes it vulnerable to **bus-off attacks**.
    
- The attacker can manipulate the **TEC** (Transmit Error Counter) of a healthy ECU by injecting attack messages, causing the victim ECU to reach an error state.
    

---
