# IoT System Architecture
## Communication Paradigms
- **Client/Server**: sources explicitly know the destination of their messages.
- **Publish/Subscribe**: sources publish to a logical channel; interested destinations subscribe (one-to-many, no explicit sessions).
- Typical IoT traffic flows:
    - **Asynchronous events** (uplink)
    - **Periodic or on-demand measurements** (uplink)
    - **Commands** from processing platforms (downlink)

---

## Properties of an IoT System
- **Trustworthiness**: availability, resilience, confidentiality, integrity, safety.
- **Architectural**: composability, modularity, heterogeneity, scalability, legacy support, shareability, unique identification.
- **Functional**: accuracy, auto-configuration, context-awareness, big data management, discoverability, real-time, self-description, compliance.

---

## Standard Reference Model
- **Physical Entity Domain (PED)**: monitored physical objects.
- **Sensing & Controlling Domain (SCD)**: sensors, actuators bridging physical ↔ cyber world.
- **Operations & Management Domain (OMD)**: OSS + BSS for provisioning, assurance, optimization.
- **Resource Access & Interchange Domain (RAID)**: service interfaces with access policies.
- **Application & Service Domain (ASD)**: end-user services via APIs or portals.
- **User Domain (UD)**: human/digital users via devices (PCs, smartphones, control panels, smart glasses)

![[Pasted image 20251001094808.png]]

---

## Network Architectures
- **One-level**: endpoints use full IP stack (e.g., cellular).
- **Two-level (1b)**: endpoints resource-constrained, gateway manages protocols (LPWA, Low Power Wide Area: LoRa, SigFox, NB-IoT). *Target of the course*
- **Two-level (1c)**: endpoints support TCP/IP, traffic managed by router (Ethernet/Wi-Fi)



---

## WANs
- TCP/IP networks, shared among users.
- Public by nature.
- **VPNs**: reserved bandwidth/security for defined groups, with private IP addressing
- Users outside of a group cannot communicate directly with users of the group.
- Use private IP addressing and private routing protocol instances.

---

## Topologies
- **Bus**: every nodes taps into a shared medium (CSMA/CD), collisions possible.
- **Ring**: token-based, eliminates collisions, requires token management.
- **Star**: master/slave, predictable, not scalable (master bottleneck).
- **Mesh**: full or partial, robust, private, many physical links

---

# Endpoints

## Sensors
- Devices detecting stimuli → electrical/processable output.
- Types: pressure, temperature, biometric, chemical, acoustic, optical, positioning, etc.
- Three classifications:
	- **Fixed**: stable, not moving like domotics
	- **Mobile**: always moving (GPS, wearables)
	- **Nomadic**: they move but then they stop somewhere else (portable medical devices, field sensors)
- **Active vs Passive** sensors
	- **Active**: need to run a current or send a signal to get a measurement (e.g., clocks, strain gauges, radar).
	- **Passive**: use the physical phenomenon itself (e.g., piezoaccelerometers, GPS, thermocouples).

### Actuators
- Output elements performing actions.
- **Digital**: on/off switching.
- **Analog**: continuous signals (e.g., motor speed control).

### Gateways
- Bridge sensors ↔ higher-level processing/cloud.
- Provide connectivity, data collection, filtering, storage, event processing, optional analytics

### Fog Nodes
- “Bring the cloud to the ground.”
- More powerful than gateways, allow **local analytics with lower latency**.

---

# Data plane functions
## Data acquisition and processing

- In order to get a digital signal from a sensor, we need to account for:
    
    - Sampling
    - Aliasing
    - Quantization
    - Saturation
    - Hysteresis and non-linearities
    - Calibration
    - Error propagation

---

### **Data acquisition and processing: Sampling**

- First, we sample: we take (regular) measurements over time, and represent the signal with those measurements.
- Nyquist theorem: if sampling is ≥ twice as fast as the signal, sampling has no errors.
- Example: If a signal is thought to have a maximum frequency between 1000 Hz and 4000 Hz, which of the following would be the most appropriate sample rate?
    - a. 500 Hz
    - b. 8000 Hz
    - c. 9000 Hz
    - d. 24000 Hz

### **Data acquisition and processing: Aliasing**
- If we do not sample “enough,” we have aliasing: patterns in the sampled version.
- A high frequency component in the frequency spectrum of a signal takes the identity of a lower frequency component in the same spectrum of the sampled signal.
- This falsely estimated signal will be indistinguishable from (i.e., be an "alias" to) another signal having that true lower frequency.
- There are tools to avoid this, but we need to know it is an issue.
- Example: aliasing in a sine wave.
![[Pasted image 20251007085600.png]]

### **Data acquisition and processing: Quantization**
- Digital values are finite: we cannot represent continuous values precisely!
- Quantization always introduces an error, which is the sensor’s natural error.
- More bits, better resolution (but more data)

![[Pasted image 20251007085902.png]]

### Data acquisition and processing: Saturation

- Sensors often have an upper limit, which is either physical or dictated by the maximum quantization level: in this case, we have saturation (all higher values are mapped to the same output)
- This is what happens when you take a picture with high exposure: all lighter points are bright white!
![[Pasted image 20251007090152.png]]

### Hysteresis
- Sometimes sensors takes a while to track the process because the **physical nature of the measurement is slow**
- Which means we have Hysteresis error when the delay of sensor measurements depends on the magnitude of the change.

- Example: When you apply pressure to a sensor and then release that pressure, the sensor’s output should in theory return you to the same value it started at before that specific pressure cycle. However, in reality, there are often small differences between the initial value and the final value after a pressure cycle.
	- From 0 to 100 bar
	- 0 bar → 0 V
	- 100 bar → 2500 V
	- 0 bar → 0.05 V
		- **0.02% / 1 bar hysteresis**

### Non-linearities
- Ideally, sensors should also have linear responses: in reality, there are often non-linear effects that we need to adjust for.

- Hard to predict

- Example: A linear sensor’s output will change by equal amounts for equal pressure changes across its entire range.
	- From 0 to 10 bar
	- 0 bar → 0 V
	- 10 bar → 5 V
	- 3 bar → 4.2 V (while I would have expected 3.75 V, according to the previous data).
		- **≤2% non-linearity of full scale**

### Calibration

- Sensors often require calibration to give proper results:
    - Bias is a constant error term in one direction.
    - Distortion is due to non-linearity.

- By measuring a series of known quantities, we can compensate for these issues (however, external factors such as temperature can throw off calibration!)
- Example: Using the data from the calibration sheet, we see that the deviations are all less than the maximum deviation allowed of 0.5%.


### Error propagation

- Calculations can change the error of a measurement, as the errors are also considered in the function you compute.
- Non-linear functions can have weird effects with measurement errors.
- Derivation (e.g., computing velocity from position measurements) is brittle: since the measurements are close together, noise can have a huge effect.
- Integration/averaging are robust (rely on many points, and noise is compensated).
- Example: Calculating heat index
    - Temperature sensor: measured (30°) with uncertainty ±0.5
    - Humidity sensor: measured (70%) with uncertainty ±2% (= 0.02)
    - Heat index = T + 0.33×RH−0.7 = 52.4
    - **Uncertainty with error propagation: 0.828 > (0.5 + 0.02)**

---

### External data communication
- Sensors data may need to be shared with external parties, such as other peer nodes at the edge, fog, and cloud levels.
- Messages exchanged between IoT nodes may be delivered using **push** or **pull** modes.
	- **Pull**: a message is explicitly requested from the source (server) by its recipient, an IoT client.
	- **Push**: the data source and the gateway send data when the specified conditions are met, such as arrival of the data sampling time mark, or exceeding of the measurement threshold.
- **Publish/subscribe system**: data sources “publish” data to a known place, and authorized clients can “subscribe” to data of interest and receive related messages.
	- Publishers do not need to know the identity or number of their receivers (subscribers), and the receivers do not need to know the identity or state of their publishers.

### how to share sensors’ data?

- Some processes (e.g., an electricity meter, a room thermostat) do not need to be sampled very often.
- If we only care about cumulative measures (how much electricity was consumed in total), we do not need frequent samples!
- On the other hand, faster processes need frequent samples, as process can change faster.
- Why don’t we transmit all the time?
- There are several reasons why we cannot transmit all the time, but we will concentrate on two of them in this first part of the course:
    - Limited bandwidth
    - Limited energy
- Each transmission (and, in fact, each activity the sensor performs) costs energy, as well as blocking the wireless channel for other transmissions

### some solutions to send sensors’ data more efficiently

- **Interpolation**
    - Interpolation is the mathematical tool to infer missing data from sparse samples. We have to make some assumptions on the nature of the process to be able to interpolate: if we have the correct model, we can send a lot fewer data samples!
    - Interpolation can also be dangerous: we can underfit (select a model that is too simple) or overfit (select a model that is too complex and ends up following random noise).
![[Pasted image 20251007093806.png]]

- **Spatial correlation**
	- Data are usually correlated in space:
	    - Traffic on either side of a bridge.
	    - Temperatures close together.
	- There can be easy natural relations (points close together are similar) or structural relations (connected points are similar).
	- Since measurements have errors, correlations help us improving the quality of estimates: we can make statistical calculations and estimates to figure out what is happening in points (like the purple one on the bridge) where we have no sensors, or refine our estimates.

- **Temporal correlation**
	- Data are also correlated in time:
	    - Traffic in one spot
	    - Temperature measured by one sensor
	- The relation here can be more or less complex, and depend on space as well (e.g., line at a traffic light), but we can also exploit this to get better data with fewer transmissions.
	- Correlations can be misleading and dangerous! When relying on statistical information to reconstruct missing data or make decisions, we need to be aware that random chance is always a possibility.

---

### Local control

- Provided in systems where latency is critical and/or edge autonomy is required.
- Local control enables the edge node to execute pre-defined control sequences when a specified condition occurs on some combination of local data.
- If This Then That: scenes where lights and heating/cooling are adjusted accordingly when users are leaving or approaching their homes.
- **Node-RED**: provides a graphical user interface to construct data flows with the functional processing modules and actuation output stages.
- In the extreme case of temperature, the script triggers the device shutdown.

![[Pasted image 20251007094532.png]]

### Data storage

- Data storage for the acquired data may be provided by the gateway.
- The existence of local storage provides the flexibility to conserve network bandwidth and to reduce the load on cloud resources by selectively reporting data that meet certain conditions.
	- **Semantic communication.**
	- Depending on the nature of the physical thing being measured, **only some of the data points may be of interest**. E.g., successive minor changes may be of little interest, but those that exceed a comfort guard band or change by a significant percentage or amount from prior readings are.
	- Qualifying readings may be defined as events and reported only when they occur, with raw readings stored in the local database should they be required for auditing or subsequent analysis.


### (Edge) analytics

- Edge analytics for the data may be provided by the gateway or the fog node.
- Proximity to data sources: low latency.
- Ability to process high-frequency data samples (at the rate of the sensor) → real-time.
- Conservation of network bandwidth by not sending data to the cloud.
- Can operate even in disconnected mode.
- Analytics generally require AI/ML models:
    - Insufficient computational resources at the edge.
    - No data aggregation of edge/local data.
- IoT systems should be implemented using design tools and practices that facilitate flexible allocation of functions (in tandem between edge and cloud).

### Analytics placement

- Optimal placement of data and processing functions is an age-old trade-off in distributed systems. 
- It is based on whether it is more cost-effective to move the data to the computation or to move the computation to the data, depending on:
    - Availability and cost of bandwidth
    - Latency requirements for time-critical operations
    - Local autonomy of operations, including disconnected mode
    - Security and data control or privacy concerns
    - Cost and complexity of managing distributed nodes with computing and storage
    - Available energy resources
    - Available computational capacity
    - …

---

# Control plane functions

- Fully functional gateways may be fairly sophisticated computational and communications nodes that host and execute a variety of services.
- They need to be properly secured and managed.
- Main control functionalities:
    - Fault management (troubleshooting, error logging, and recovery).
    - Remote monitoring, control, administration, and diagnostics.
    - Remote firmware and software updates.
    - Security updates.
    - Metering (network bandwidth and software usage) and supervision.
    - Provisioning and authentication.

---

### (Cyber)security

- The first step is to determine the security risk.
- Identify, quantify, and prioritize the risks for the system, and find a balance between costs and potential losses from residual risks.
- Model to quantify risk: vulnerability, threats, and impacts.
![[Pasted image 20251007095925.png]]

- **Vulnerabilities**: can originate from the design of the system architecture, technology, and protocols, but more often emerge in the implementation (e.g., coding flaws) and in the operation phases (e.g., configuration errors, use of weak credential, unparched devices, unexpert use, etc.).
    
- **Security measures for the diligent user**:
    - Partitioning the system into zones (characterized in terms of security levels).
    - Adopt effective authentication protocols, tailored to the different zones.
    - Provide cryptographic protection of data.
    - Install equipment from trusted providers.
    - Make and install frequent patches and workarounds (software updates).
    - …

- **Threat**: an IoT network is a possible point of attack if the endpoint is unguarded and is positioned in an easily reachable position.
	- **Eavesdropping**: learning confidential information.
	- **Traffic analysis**: learning data origin, destination, and length (not the content).
	- **Forgery**: building a fake message, pretending it was sent by someone else.
	- **Masquerade**: claiming to be someone else in a single message.
	- **Repudiation**: denying having sent or received a message.
	- **Profiling**: gathering information about a single user.
	- **Fingerprinting**: identifying the user associated with a message.
	- **Jamming**: causing interference to a communication.

- **Standards**: IoT-oriented and industry-specific standards have been developed for security.
![[Pasted image 20251007100557.png]]

---

### Provisioning and authentication
- **Provisioning**: the lifecycle of an endpoint begins with its provisioning in the network.
- It is the process of giving the endpoint the configuration data and the ability to present itself.
- **Authorization**: checking the rights of access to the network.
- **Application-level authentication**: used if the network is shared among applications.
- **Authentication**: verification of the identity (“I know your name, is it you?”).
- **Challenge-response protocol**: employs secret keys for verification.

![[Pasted image 20251007101013.png]]

---

# QoS and performance

- **One-way delay (OWD)**: time between the transmission of the first bit of a packet at an interface and the reception of the last bit of the packet at the other interface.
    
- Requires perfect time synchronization between the endpoints.
    
- **Time reference**: Network Time Protocol (NTP).
    
- **Two-way delay (TWD)**: time between the transmission of the first bit of a packet at an interface and the reception of the last bit of the packet at the same interface, after being reflected by the system at the other end, net of the End System Delay (ESD, processing time at the remote node).
    
- We have that **Round Trip Time (RTT) = TWD + ESD.**

### Delay

- **Packet-delay variation (PDV)** (~jitter): based on previous OWD/TWD measures.
    
- PDV = |OWDi - OWDi-1|
    
- PDV = |OWDi - mean{OWD}|
    
- PDV = |OWDi - min{OWD}|
    
- PDV = |OWDi - OWD1|
    
- …

- **Problem**: These delay metrics do not consider the MAC delay (for channel access).
    
- **End-to-end delay (E2E)**: it consists of (at least) three components:
    
    - **MAC delay** (under the control of the system designer).
        
    - **Access link and gateway delay** (under the control of the system designer).
        
    - **OWD** (depends on the WAN).


#### Delay and “real-time”
- The expression **“real-time”** may have different interpretations:
    - **Synchronization** to a common time reference.
    - **Responding fast.**
    - **Responding within predictable response times.**
        
- **Hard real-time**: if the response exceeds a limit, the system does not operate well.
    - Example: respond within 5 ms
    - **CASE 1:** The application always responds in 4 ms
        - Average delay: 4 ms; Failure rate: 0%
    - **CASE 2:** The application responds in 1 ms for 99.9% of the times, and in 6 ms in 0.01%.
        - Average delay: 1.005 ms; Failure rate: 10⁻³
- **Soft real-time**: it involves some response time percentiles.

#### Packet loss

- In an IoT network, **loss may occur** if:
    - The **buffers of a node overflow.**
    - **Transmission errors** (negligible in wired LANs, dominant in wireless LANs).
    - **Delay much larger than expected** may be considered as a loss.
        
- How to have realistic measures of packet loss? There are some problems:
    - **Long-lasting measurements:** averaging of data gives no indications on the short period.
    - **Short measurements:** no statistically meaningful data.
    - **Intense bursts:** too intrusive, altering the result (not representative of a real situation).

#### Capacity

- **Hardly a problem**, as applications are not (in general) bandwidth demanding.
- For some high-end applications (e.g., telemedicine, IIoT, automotive, etc.), **capacity** is generally less important than other metrics such as reliability.
- **Example:** metering application
    - Collect 1M samples (or sensors?) (of 128B) every 15 minutes.
    - **Average throughput:** 1,000,000 × 128B × 8 (bit) / (15 × 60) = 1.3 Mbit/s
    - If the same measurements take place as unsolicited events from the endpoint in the same second, the **link capacity** shall be around 1,000,000 × 128B × 8 (bit) = 1 Gbit/s.

Those are the most important metrics, but there are other ones related to IoT.

#### Reliability

- **R(t)**: probability that a system is working as expected at a certain time _t._
	- For most systems, the early phase of “high mortality” is short and occurs during tests.
	- The system is generally replaced for obsolescence as the aging phase approaches.
	- In “normal life”, most systems shall be reliable.
- **R(t)** is memoryless: the residual life of failure does not depend on how long the system has been working → the system does not age during “normal life.”
![[Pasted image 20251008085321.png]]

#### Availability

- **Probability that the system is working** when observed at a random time instant.
    
- We assume that the system can be periodically repaired if needed and put back in service.
    
- **Mean Time Between Failures (MTBF).**
    
- **Mean Time To Repair (MTTR).**
    

$$
A = \frac{MTBF}{MTBF + MTBR}
$$
![[Pasted image 20251008085509.png]]

#### Availability (example)

- For memoryless systems, **MTBF = Mean Time To Fail (MTTF) = 1/λ.**
    
- **Example:** prevention of fires in a forest
    - _N_ sensors that monitor fires in the forest.
    - Sensors fail at rate **λ.**
    - The prevention works if _x%_ of sensors are active and alive.
    - Period of effectiveness of the system (**T**):
![[Pasted image 20251008085727.png]]

---

# Energy constraints

#### Introduction

- Most sensors and components use electrical energy, i.e., they exploit the movements of electrons across a conducting medium.    
- Powering is a very important issue, and depends on the endpoint capabilities and the network architecture procedures.

|Type|Examples|
|---|---|
|**Mains / manually recharged**|Field buses Smartphones Smart grid devices|
|**Battery**|Most sensors|
|**Data line**|Videocameras|
|**Harvesting**|Environmental sensors|

---

#### Sources of consumption — Computing

- Computing requires a certain energy for each cycle, corresponding to one basic operation. Some operations (e.g., sinusoidal functions) require multiple cycles.
	- Energy consumption is usually a function of the number of cycles required.
- If a device has a certain clock frequency, we can also compute the power it requires to perform calculations.
- Computing energy can be formalized based on the number of logical operations that are required to perform: **AND, NOT, OR, XOR.**

---

#### Sources of consumption — Boards and PLCs

- Boards and PLCs are standard circuits used in industrial automation. Larger IoT nodes also use Arduinos or other pre-made boards.
- Smaller, more efficient nodes are often designed ad hoc, to use as little energy as possible. In general, IoT nodes have limited computational capabilities.

**Example: Arduino-UNO**  
The Arduino Uno is a microcontroller board based on the ATmega328.  
It contains everything needed to support the microcontroller; simply connect it to a computer with a USB cable or power it with an AC-to-DC adapter or battery to get started.

---

#### Sources of consumption — Communication

- Digital communication usually requires more steps than just sending a wave, and each consumes energy:    
1. **Encoding and error protection.**
    - Use known redundant codes: the simplest example is the parity check bit.
    - Decoders are often complex, but can correct errors in transmission and recover the original packet. However, complexity is paid for in energy.
        
2. **Preambles for synchronization and channel estimation.**
3. **Modulation** from the baseband digital signal to the passband analog signal.
4. **Transmission** (power is applied to the antenna) (not required for reception).
	- IoT transmissions are usually slow (low bitrate), but distance plays a large role.

---

#### Source of energy — Mains power

- Provide virtually unlimited power, making it possible to employ complex protocols, work at high bitrates, and achieve long-distance communication.
- There are some drawbacks:
    - Only work in wired fixed systems.
    - Can be dangerous in environments at risk of fire and explosions.
    - Need to lay out an electric line (challenging in hard-to-reach remote/rural areas).
    - Need to put transformers (expensive).

---

#### Source of energy — Power over Ethernet (PoE)

- Employ the wired communication infrastructure also for powering.
- Can carry DC power on the twisted pair used for Ethernet connectivity.
- Only one cabled infrastructure needs to be in place.
- Transformers are not needed.

---

#### Source of energy — Powerline communication

- It is the opposite of PoE.
- Use the powerline to carry data.
- Based on modulation between high-frequency data and low-frequency electricity.
- Only one cabled infrastructure needs to be in place.
- Advantageous when the system to be monitored and controlled is the power grid itself.
![[Pasted image 20251008091052.png]]

---
#### Source of energy — Batteries

- Batteries use the charge difference between ions to induce a potential difference.
	- **Rechargeable** batteries can run the circuit backwards and move the electrons back (by connecting a stronger generator).
	- Charging is never perfect: chemical impurities build up.
- If the battery runs out completely, it is often impossible to recharge without direct intervention (which may be expensive): the objective is **never to let it run out!**
	- Apply **statistical data** and direct information from the meter to define a plan of **proactive** on-field **intervention** if needed → carry out with proper timing to minimize the number of substitutions in the lifetime and the number of dedicated “truck rolls” or manual readings.

#### Sources of energy — Batteries (management and optimization)

- Energy is the basic constraint of IoT systems. What can we do?
    - Employ battery technology with low self-discharging properties.
    - Minimize the duration of active states of the radio components with suitable scheduling algorithms and MAC protocols.
	    - Duty cycles, sleep mode, alert/notification, etc.
    - Adopt energy-aware routing.
    - Introduce endpoint management protocols that communicate the state of batteries.
    - Adopt a “let it be off” approach.
    - Recharge batteries with energy harvesting.

---

#### Source of energy — Energy harvesting

- Energy harvesting: recharge it while it is running.
- Energy harvesting sensors and actuators are equipped with some kind of generator and can recharge their battery from it. This allows them to stay alive much longer than with a single battery charge, even if they get very little energy.
![[Pasted image 20251008091530.png]]

---

#### Source of energy — Solar and wind energy

- **Solar panels** are now cheap, and solar energy is renewable and clean.
	- The sensor needs to be exposed (shade can be a problem, underground or indoor sensors will not work).
	- Photovoltaic cells will not generate any power at night (the sensor needs to get through the night on a single charge).
- Another possibility is wind energy, but there are several challenges:
    - The sensor still needs to be exposed (underground or indoor sensors will not work).
    - Wind is intermittent and unpredictable.
    - Small turbines are inefficient.

---

#### Source of energy — Thermal and vibration energy

- **Thermal energy** is cheap when the sensor has access to temperature gradients:
    - The inside/outside or ground/air gradient can generate energy.
    - The power is usually very small, but may be the only option for buried sensors.
    - Need for long distances between terminals.
    - Good for wearables: the difference between body temperature and the air is high.
- Vibration energy can be collected using piezoelectric devices with good efficiency.
- The constant presence of vibrations energetic enough to power the endpoint is uncertain, except in some industrial environments.

---

#### Source of energy — Wireless power transfer (WPT)

- Sensors can benefit from the power of received transmissions, but the benefits are tiny at longer distances: this is only feasible for very low-power sensors.
- **Inductive coupling**: uses electromagnetic fields to transfer energy between coils.
- **Capacitive coupling**: transfers energy via electric fields between conductive plates.
- Uses **RF signals** to transfer power over longer distances (several meters to kilometers).
- Uses **focused laser beams** to transmit power over long distances.

---

#### Source of energy — Passive sensors

- We can also use the received transmission to power the circuit directly: **RFID tags, biometric passports, and contactless cards** work this way.
- Power loss is huge: these only work over short distances.
- The sensor cannot actively transmit or record data, only respond to messages.
- There are **privacy issues** (anyone can read a tag, the only limit is the SNR).
![[Pasted image 20251008091951.png]]

